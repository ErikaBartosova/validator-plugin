<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tangram Game</title>
  <style>
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #container {
      display: flex;
      gap: 20px;
    }
    #board {
      width: 400px;
      height: 400px;
      border: 1px solid #ccc;
      position: relative;
      background: #f9f9f9;
    }
    .piece {
      position: absolute;
      cursor: grab;
      user-select: none;
      transition: left 0.15s ease, top 0.15s ease, transform 0.15s ease;
    }
    #preview {
      width: 180px;
      border: 1px solid #ddd;
      padding: 5px;
      background: #fff;
    }
    #preview svg {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body tabindex="0">
  <h3>Tangram</h3>
  <div id="container">
    <div id="board"></div>
    <div id="preview"><p>Preview se načte sem…</p></div>
  </div>

  <script>
    const board = document.getElementById("board");
    const preview = document.getElementById("preview");
    let targets = [];
    let lastClicked = null;

    const pieces = [
      { id: "bigTriangle1", x: 20, y: 20, type: "triangle" },
      { id: "bigTriangle2", x: 120, y: 20, type: "triangle" },
      { id: "mediumTriangle", x: 220, y: 20, type: "triangle" },
      { id: "smallTriangle1", x: 20, y: 120, type: "triangle" },
      { id: "smallTriangle2", x: 120, y: 120, type: "triangle" },
      { id: "square", x: 220, y: 120, type: "square" },
      { id: "parallelogram", x: 320, y: 20, type: "parallelogram" }
    ];

    // render dílků
    pieces.forEach(p => {
      const el = document.createElement("div");
      el.classList.add("piece");
      el.style.left = p.x + "px";
      el.style.top = p.y + "px";
      el.dataset.id = p.id;
      el.dataset.type = p.type;
      el.dataset.rotation = "0";
      el.style.width = "60px";
      el.style.height = "60px";
      el.style.background = "#aaa";
      el.style.opacity = "0.8";
      el.addEventListener("click", () => { lastClicked = el; });
      board.appendChild(el);
      makeDraggable(el);
    });

    function makeDraggable(el) {
      let offsetX, offsetY;
      el.addEventListener("mousedown", e => {
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        el.style.cursor = "grabbing";

        const onMove = ev => {
          el.style.left = ev.pageX - board.offsetLeft - offsetX + "px";
          el.style.top = ev.pageY - board.offsetTop - offsetY + "px";
        };

        const onUp = () => {
          el.style.cursor = "grab";
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
          snapEdges(el);
          triggerValidation();
        };

        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      el.addEventListener("dblclick", () => {
        let rot = parseInt(el.dataset.rotation || "0");
        rot = (rot + 45) % 360;
        el.dataset.rotation = rot;
        el.style.transform = `rotate(${rot}deg)`;
        triggerValidation();
      });
    }

    // edge snap (hrana k hraně)
    function snapEdges(el) {
      const allPieces = document.querySelectorAll(".piece");
      const rect = el.getBoundingClientRect();
      const boardRect = board.getBoundingClientRect();

      for (const other of allPieces) {
        if (other === el) continue;
        const orect = other.getBoundingClientRect();

        if (Math.abs(rect.right - orect.left) < 8) {
          el.style.left = (orect.left - boardRect.left - rect.width) + "px";
        }
        if (Math.abs(rect.left - orect.right) < 8) {
          el.style.left = (orect.right - boardRect.left) + "px";
        }
        if (Math.abs(rect.bottom - orect.top) < 8) {
          el.style.top = (orect.top - boardRect.top - rect.height) + "px";
        }
        if (Math.abs(rect.top - orect.bottom) < 8) {
          el.style.top = (orect.bottom - boardRect.top) + "px";
        }
      }
    }

    // keyboard ovládání
    document.body.addEventListener("keydown", (e) => {
      if (!lastClicked) return;
      const step = 5;
      const left = parseInt(lastClicked.style.left) || 0;
      const top = parseInt(lastClicked.style.top) || 0;

      if (e.key === "ArrowUp") lastClicked.style.top = (top - step) + "px";
      if (e.key === "ArrowDown") lastClicked.style.top = (top + step) + "px";
      if (e.key === "ArrowLeft") lastClicked.style.left = (left - step) + "px";
      if (e.key === "ArrowRight") lastClicked.style.left = (left + step) + "px";

      triggerValidation();
    });

    // automatická validace
    function triggerValidation() {
      const state = Array.from(document.querySelectorAll(".piece")).map(el => {
        const rect = el.getBoundingClientRect();
        return {
          id: el.dataset.id,
          type: el.dataset.type,
          x: rect.left - board.getBoundingClientRect().left + rect.width/2,
          y: rect.top - board.getBoundingClientRect().top + rect.height/2,
          rotation: parseInt(el.dataset.rotation || "0")
        };
      });

      parent.postMessage({ 
        pluginMessage: { 
          type: "validate-shape", 
          pieces: state, 
          targets 
        } 
      }, "*");
    }

    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === "validation-result") {
        if (msg.success) {
          preview.style.border = "2px solid green";
        } else {
          preview.style.border = "1px solid #ddd";
        }
      }
      if (msg.type === "solution-loaded") {
        preview.innerHTML = msg.svg;
        targets = msg.targets;
      }
      if (msg.type === "solution-error") {
        preview.innerHTML = `<p style="color:red">${msg.error}</p>`;
      }
    };

    // default sneak peek
    parent.postMessage({ pluginMessage: { type: 'load-solution', shapeName: 'Heart shape' }}, "*");
  </script>
</body>
</html>
